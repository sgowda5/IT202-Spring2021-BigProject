<!DOCTYPE html>
<html>
<head>
  <title>IT202-Spring2021-BigProject</title>
  <link rel="manifest" href="manifest.json" />
<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://unpkg.com/material-components-web@10.0.0/dist/material-components-web.min.css" rel="stylesheet">
 <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <style>
     #map {
        height: 100%;
      }
    .screen {
      display: none;
    }

    body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

  </style>

</head>

<body>

  <header class="mdc-top-app-bar">
      <div class="mdc-top-app-bar__row">
        <section class="mdc-top-app-bar__section mdc-top-app-bar__section--align-start">
          <button class="material-icons mdc-top-app-bar__navigation-icon mdc-icon-button" aria-label="Open navigation menu">menu</button>
        <span class="mdc-top-app-bar__title">Public Safety App</span>
      </section>
    </div>
  </header>
 
  <aside class="mdc-drawer mdc-drawer--modal">
    <div class="mdc-drawer__header">
      <br>
        <h3 class="mdc-drawer__title">Public Safety App</h3>
    </div>
    <div class="mdc-drawer__content">
      <nav class="mdc-list">
        <a class="mdc-list-item mdc-list-item--activated" href="#HomeScreen" aria-current="page" tabindex="0" aria-selected="true">
          <span class="mdc-list-item__ripple"></span>
          <i class="material-icons mdc-list-item__graphic" aria-hidden="true">home</i>
          <span class="mdc-list-item__text">Home</span>
        </a>
        <a class="mdc-list-item" href="#map" tabindex="-1" aria-selected="false">
          <span class="mdc-list-item__ripple"></span>
          <i class="material-icons mdc-list-item__graphic" aria-hidden="true">help_outline</i>
          <span class="mdc-list-item__text">police stations</span>
        </a>

        <a class="mdc-list-item" href="#NASA" tabindex="-1" aria-selected="false">
          <span class="mdc-list-item__ripple"></span>
          <i class="material-icons mdc-list-item__graphic" aria-hidden="true">image</i>
          <span class="mdc-list-item__text">NASA</span>
        </a>

        <a class="mdc-list-item" href="#policeDress" tabindex="-1" aria-selected="false">
          <span class="mdc-list-item__ripple"></span>
          <i class="material-icons mdc-list-item__graphic" aria-hidden="true">photo_camera</i>
          <span class="mdc-list-item__text">Police Dress</span>
        </a>

        <a class="mdc-list-item" href="#abtMe" tabindex="-1" aria-selected="false">
          <span class="mdc-list-item__ripple"></span>
          <i class="material-icons mdc-list-item__graphic" aria-hidden="true">help_outline</i>
          <span class="mdc-list-item__text">About me</span>
        </a>
      </nav>
    </div>
  </aside>

  <div class="mdc-drawer-scrim"></div>
  <main class="mdc-top-app-bar--fixed-adjust">
    
    <div id="HomeScreen" class="screen">
      <center>
      
        
        <h5 class="mdc-typography--headline4">Welcome to the Public Safety App</h5>

        <label class="mdc-text-field mdc-text-field--filled">
          <span class="mdc-text-field__ripple"></span>
          <span class="mdc-floating-label" id="my-label-id">Enter Your Name</span>
          <input class="mdc-text-field__input" id="EnterName" type="text" aria-labelledby="my-label-id">
          <span class="mdc-line-ripple"></span>
        </label>         
        
        <button class="mdc-button mdc-button--raised" id="enterBtn">
          <div class="mdc-button__ripple"></div>
          <span class="mdc-button__label">Enter</span>
        </button>

        <div class="mdc-snackbar">
          <div class="mdc-snackbar__surface" role="status" aria-relevant="additions">
            <div class="mdc-snackbar__label" aria-atomic="false">
              Welcome
            </div>
            <div class="mdc-snackbar__actions" aria-atomic="true">
              <button type="button" class="mdc-button mdc-snackbar__action">
                <div class="mdc-button__ripple"></div>
                <span class="mdc-button__label"></span>
              </button>
            </div>
          </div>
        </div>
     </div>
    </center>

    <script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>

<script>

      var db = new Dexie("db");
      db.version(1).stores({
          users: 'name'
      });

      document.querySelector("#enterBtn").addEventListener("click", (event) => {
       db.players.put({name: txtInp.value, date: new Date()})
      .then ( (item) => {
        snackbar.labelText = "****Welcome " + inp + "****";
        snackbar.open();
      });
      
      });


</script>


    <div class="screen" id="map">
      <h1>Map</h1>
    </div>


    <script>
      // let map;

      // function initMap() {
      //   map = new google.maps.Map(document.getElementById("map"), {
      //     center: { lat: 41.8781, lng: -87.6298 },
      //     zoom: 11,
      //   });
      // }
    </script>

    <script>

      // let markers = [];

      //   let url = "https://data.cityofchicago.org/resource/z8bn-74gv.json";

      //   fetch (url)
      
      //   .then ( (response)=> {
      //     return response.json()
      //   })

      //   .then ( (json) => {
      //     for (let station of json) {
            
      //     let lat = parseFloat(station.latitude);
      //     let lng = parseFloat(station.longitude);
          
      //     console.log(lat);
      //     console.log(lng);

      //       let marker = new google.maps.Marker({
      //         position: {lat: lat, lng: lng},
      //         map: map
      //       });
            
      //       markers.push(marker);

      //       let content = "Address : " + station.address;

      //       let infoWindow = new google.maps.InfoWindow({
      //         content: content,
      //         maxWidth: 200,
      //       });
            
      //       marker.addListener("click", () => {
      //         infoWindow.open(map, marker);
      //       });            
      //     }
      //   });
    </script>
    
    <!-- <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBi4ebxAJ7t5QYcg-s49FzUn-d2wdfHD6A&callback=initMap&libraries=&v=weekly"
      async
    ></script>
     -->
    <div id="NASA" class="screen">
      <div id="NSBODY">
      <h5 class="mdc-typography--headline3">NASA</h5>
      <h1 id="SH1"></h1>
      </div>
    </div>


    <script>

        fetch ("https://api.nasa.gov/planetary/apod?api_key=jfmJBQV0xTVlEOMAhKwtVWeJjRVCmtVVxIivIEsk")
        
        .then ( (response)=> {
          return response.json()
        })

        .then ( (response) => {
          let h1 = document.querySelector("#SH1")
          h1.innerText = response.title;
          let img = document.createElement("img");
          img.id = "SIMG";
          let imgSrc = response.url; 
          img.setAttribute("src", imgSrc);
          img.setAttribute("width", 500);
         document.querySelector("#NSBODY").appendChild(img);
          let p = document.createElement("p");
          p.id = "S1P";
          p.innerText = response.explanation;
          document.querySelector("#NSBODY").appendChild(p);

        });
    </script>

    <div id="abtMe" class="screen">
      <center>
        <h5 class="mdc-typography--headline4">About Me</h5>
        <p class="mdc-typography--body1">I am Surya Gowda and I am a Computer Science Student at the University of Illinois at Chicago.</p>
      </center>
    </div>

   <div id="policeDress" class="screen">
        <h5 class="mdc-typography--headline4">Police Dress</h5>
        <h5 class="mdc-typography--headline6">Dress Up as a Cop</h5>
        <video id="player" width="320" height="240" controls autoplay></video>
        <canvas id="canvas" width="320" height="240"></canvas>
       <br>
       <button class="mdc-button mdc-button--raised" id="click">
          <div class="mdc-button__ripple"></div>
          <span class="mdc-button__label">Choose</span>
        </button>
        <div id="imageOptions">
        </div>
    </div>
 
  <script>
    const images = [
      {
          "file": "icons/policeHat.png",
          "type": "mask",
          "eye_distance": 800,
            "offset_horizontal": 1200,
            "offset_vertical": 2300
          }
      ];

          // image object for the overlay
          let activeImage = images[0];
          let activeImageObject = new Image();
          activeImageObject.src = activeImage["file"];

          // cleaner code if we have these as variables
          const supported = 'mediaDevices' in navigator;
          const player = document.getElementById('player');
          const canvas = document.getElementById('canvas');
          const context = canvas.getContext('2d');
          const captureButton = document.getElementById('capture');
          const dataDiv = document.getElementById('imageData');
          

          // 
          const visionApiEndpoint = "https://vision.googleapis.com/v1/images:annotate";
          let requestBody;
          

          // for invoking the camera
          const constraints = {
            video: true,
          };
        

          // Attach the video stream to the video element and autoplay.
          navigator.mediaDevices.getUserMedia(constraints)
          .then((stream) => {
            player.srcObject = stream;
          });


          // capture button listener
          captureButton.addEventListener('click', () => {
            // Draw the video frame to the canvas.
            context.drawImage(player, 0, 0, canvas.width, canvas.height);
            // get the image facial data
            getImageData("FACE_DETECTION");
          });
        
          

          // display the nose-and-glasses images in the DOM
          images.forEach( (item, idx) => {
            let img = document.createElement("img");
            img.setAttribute("src",  item.file);
            img.classList.add("image-option");
            img.setAttribute("data-index", idx);
            if (item == activeImage) {
              img.classList.add("image-option-active");
            }
            document.querySelector("#imageOptions").append(img);
          });


          // handler to set the active image
          document.querySelectorAll(".image-option").forEach ( (item) => {
            item.addEventListener ("click", (event) => {
              document.querySelector(".image-option-active").classList.remove("image-option-active");
              event.target.classList.add("image-option-active");
              activeImage = images[event.target.getAttribute("data-index")];
              activeImageObject.src = activeImage["file"];
            });
          });


            
            
          let getImageData = (type) => {
             
             // structure the request body based on Cloud Vision API docs
             requestBody = {
                "requests":[
                  {
                    "image":{
                      "content":canvas.toDataURL().split(",")[1]
                    },
                    "features":[
                      {
                        "type": type,
                        "maxResults":10
                      }
                    ]
                  }
                ]
              };


              fetch(visionApiEndpoint + "?key=AIzaSyAo8wxpndP-WXNjYkNEfeZQ7B1W--2D9MM", {
                method: "POST",
                headers: {
                  'Content-Type': 'application/json;charset=utf-8'
                },
                body: JSON.stringify(requestBody)

              })
              .then ( (response) => {return response.json() })  
              .then (function(data) {

                  /*
                      nose and glasses lens centers are about 300px apart,
                      so we'll have to scale to paste on face.
                  */
                  
                  let left_eye = data.responses[0].faceAnnotations[0].landmarks.filter((el) => {return el.type == "LEFT_EYE"})[0];

                  // let right_eye = response.responses[0].faceAnnotations[0].landmarks.filter(function(el) {return el.type == "RIGHT_EYE_PUPIL"})[0];
                  let right_eye = data.responses[0].faceAnnotations[0].landmarks.filter((el) => {return el.type == "RIGHT_EYE"})[0];
                  
                  
                  /*  compare the distance between the eyes in the response data 
                        to the distance between the lens centers to get a scaling pct 
                  */

                  // distance for the active image
                  let imageEyeDistance = activeImage["eye_distance"];


                  let rightX = right_eye.position.x;
                  let leftX = left_eye.position.x;

                  let eye_distance = parseInt(rightX) - parseInt(leftX);
                  
                  
                  let scale_pct = eye_distance/imageEyeDistance;   

                  /*  after getting that part working, I needed to offset
                      the destination x,y due to drawImage dest x,y as the 
                      top left corner of the image we're drawing;
                      I had to look at the nose/glasses image;  I found the center of the right-eye lens is 150 x and 100 y from the top left of the image
                  */

                  let destOffsetX = -1*activeImage["offset_horizontal"];
                  let destOffsetY = -1*activeImage["offset_vertical"];


                  /* after some more playing around, I realized that "right eye"
                      in the data doesn't mean *my* right eye; I actually need to offset from the "left (most) eye (in the image)"
                  */

                  let leftY = left_eye.position.y;

                  let destX = leftX + (destOffsetX*scale_pct);
                  let destY = leftY + (destOffsetY*scale_pct);
                  


                  /* and finally, to avoid problems in getting the data url of a 
                      canvas that has been modified, I'm putting the "funny nose"
                      version into a separate canvas
                  */


                  context.drawImage(
                    activeImageObject,                    // the image
                    destX,                                  // horiz offset
                    destY,                                  // vert offset
                    activeImageObject.width*scale_pct,    // the scaled width
                    activeImageObject.height*scale_pct    // the scaled height
                  );

                  /* you could certainly check the tilt of the
                      face and rotate the funny glasses image accordingly */

                });
        
          }
    </script>


</main> 


   <script>
      const drawer = mdc.drawer.MDCDrawer.attachTo(document.querySelector('.mdc-drawer'));
      const topAppBarElement = document.querySelector('.mdc-top-app-bar');
      const listEl = document.querySelector('.mdc-drawer .mdc-list');
      const mainContentEl = document.querySelector('main');
      listEl.addEventListener('click', (event) => {
        drawer.open = false;
      });
      document.querySelector("header button.mdc-top-app-bar__navigation-icon").addEventListener("click", (event) => {
   drawer.open = true;
      });
window.addEventListener('click', () => {
  drawer.open = false;
      });
document.body.addEventListener('MDCDrawer:closed', () => {
      });

    document.querySelectorAll('.mdc-list-item').forEach((element) => {
      element.addEventListener('click', (event) => {
        muteScreens();
        let href = event.target.getAttribute("href");
        document.querySelector(href).style.display="block";
      });
    });
    
    let muteScreens = () =>{
      document.querySelectorAll(".screen").forEach((element) => {
        element.style.display="none";
      });
    }

    </script>

    <script>
      window.addEventListener('load', (event) => {
        document.querySelector("#HomeScreen").style.display="block";
      });
    </script>

    <script>
        if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker.register("./sw.js", { scope: "." }).then(
            (registration) => {
              console.log(
                "ServiceWorker registration successful with scope: ",
                registration.scope
              );
            },
            (err) => {
              console.log("ServiceWorker registration failed: ", err);
            }
          );
        });
      } 
    </script>

  </body>
</html>